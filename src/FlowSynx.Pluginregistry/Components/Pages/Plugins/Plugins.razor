@page "/plugins"

@using FlowSynx.PluginRegistry.Application.Features.Plugins.Query.PluginsList
@using FlowSynx.PluginRegistry.Application.Wrapper
@using FlowSynx.Pluginregistry.Components.Shared
@using FlowSynx.Pluginregistry.Services
@using Microsoft.AspNetCore.WebUtilities

@implements IDisposable

@inject NavigationManager Navigation
@inject IStatsApiService Stats

<PageTitle>Plugins | FlowSynx Plugin Registry</PageTitle>

<div class="container py-5">
    <div class="row">
        @if (plugins == null)
        {
            <div class="col-12">
                <LoadingSpinner Message="Loading plugins..." />
            </div>
        }
        else if (!plugins.Succeeded)
        {
            <div class="col-12">
                <div class="mb-3">
                    <BadgeCounter Text="@($"{plugins?.Data?.Count() ?? 0} plugins found")" />
                </div>
                <ErrorAlert Message="@string.Join(Environment.NewLine, plugins?.Messages!)" />
            </div>
        }
        else if (plugins?.Data?.Count() == 0)
        {
            <div class="col-12">
                <div class="mb-4">
                    <BadgeCounter Text="0 plugins found" />
                </div>
                <EmptyState Title="No Plugins Found"
                           Message="We couldn't find any plugins matching your search criteria."
                           ResetUrl="/plugins"
                           ResetButtonText="Clear Search" />
            </div>
        }
        else
        {
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <BadgeCounter Text="@($"{plugins?.Data?.Count() ?? 0} {(plugins?.Data?.Count() == 1 ? "Plugin" : "Plugins")} available")"
                                 BadgeClass="bg-primary-subtle text-primary-emphasis" />
                </div>

                @foreach (var plugin in plugins?.Data!)
                {
                    <PluginCard Plugin="@plugin" />
                }

                <Pagination CurrentPage="@currentPage" TotalPages="@totalPages" />
            </div>
        }
    </div>
</div>

@code {
    PaginatedResult<PluginsListResponse>? plugins;
    private int currentPage = 1;
    private int totalPages => plugins == null ? 1 : plugins.TotalPages;
    private string? query = "";

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await LoadPage();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        await LoadPage();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadPage()
    {
        var uri = new Uri(Navigation.Uri);
        if (!string.IsNullOrWhiteSpace(uri.Query))
        {
            var queryStrings = QueryHelpers.ParseQuery(uri.Query);

            if (queryStrings.TryGetValue("page", out var pageStr) && int.TryParse(pageStr, out var page))
                currentPage = Math.Max(page, 1);
            else
                currentPage = 1;

            if (queryStrings.TryGetValue("q", out var q))
                query = q;
            else
                query = "";
        }

        try
        {
            plugins = await Stats.GetPlugins(query, currentPage).ConfigureAwait(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching plugins: " + ex);
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}