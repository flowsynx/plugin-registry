@page "/plugins/{Type}/{Version}"

@using System.Text.Json
@using System.Security.Claims
@using FlowSynx.PluginRegistry.Application.Features.Plugins.Query.PluginDetails
@using FlowSynx.PluginRegistry.Application.Wrapper
@using FlowSynx.Pluginregistry.Helpers
@using FlowSynx.Pluginregistry.Services
@using FlowSynx.Pluginregistry.Components.Shared;
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop

@inject NavigationManager Navigation
@inject IStatsApiService Stats
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Plugin details for @Type version @Version | FlowSynx Plugin Registry</PageTitle>

@if (plugin != null && plugin.Succeeded)
{
    <MetaTags Title="@($"{Type} v{Version}")"
              Description="@plugin.Data.Description"
              Author="@string.Join(",", plugin.Data.Owners)"
              Keywords="@string.Join(",", plugin.Data.Tags)"
              OgTitle="@($"{Type} v{Version}")"
              OgDescription="@plugin.Data.Description"
              OgUrl="@plugin.Data.RepositoryUrl"
              TwitterSite="@plugin.Data.RepositoryUrl"
              TwitterCreator="@string.Join(",", plugin.Data.Owners)" />
}

<div class="container py-5">
    @if (plugin == null)
    {
        <div class="col-12">
            <LoadingSpinner Message="Loading plugin details..." />
        </div>
    }
    else if (!plugin.Succeeded)
    {
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="alert alert-danger border-0 shadow-sm d-flex align-items-start" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-3" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                    </svg>
                    <div>
                        <h5 class="alert-heading mb-2">Error Loading Plugin</h5>
                        <p class="mb-0">@string.Join(Environment.NewLine, plugin.Messages)</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Plugin Header -->
                <div class="card border shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
                            <div class="d-flex flex-grow-1">
                                <div class="plugin-header-icon me-3">
                                    <img src="/api/plugins/@plugin.Data.Type/@plugin.Data.Version/icon"
                                         class="rounded-3 shadow-sm"
                                         style="width: 80px; height: 80px; object-fit: contain;"
                                         alt="@plugin.Data.Type icon" />
                                </div>

                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
                                        <h1 class="h2 fw-bold mb-0">@plugin.Data.Type</h1>
                                        
                                        @if (plugin.Data.IsTrusted)
                                        {
                                            <span class="badge bg-primary-subtle text-primary-emphasis fs-6" title="Trusted Plugin">
                                                <i class="bi bi-patch-check-fill me-1"></i>Trusted
                                            </span>
                                        }
                                        
                                        @if (!plugin.Data.IsActive)
                                        {
                                            <span class="badge bg-warning-subtle text-warning-emphasis fs-6">
                                                <i class="bi bi-eye-slash me-1"></i>Unlisted
                                            </span>
                                        }
                                    </div>

                                    <div class="text-muted mb-2">
                                        <i class="bi bi-tag me-1"></i>
                                        <span class="fw-semibold">Version @plugin.Data.Version</span>
                                    </div>

                                    <div class="d-flex flex-wrap gap-3 text-muted small">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-download text-primary me-2"></i>
                                            <strong class="text-dark">@plugin.Data.TotalDownload.ToString("N0")</strong>
                                            <span class="ms-1">downloads</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-clock-history text-primary me-2"></i>
                                            <span>Updated @TimeHelper.GetHumanReadableDate(plugin.Data.LastUpdated)</span>
                                        </div>
                                    </div>

                                    <!-- Description -->
                                    @if (!string.IsNullOrEmpty(plugin.Data.Description))
                                    {
                                        <p class="text-muted mt-2 mb-3 small">@plugin.Data.Description</p>
                                    }

                                    @if (isOwner)
                                    {
                                        <div>
                                            @if (isProcessing)
                                            {
                                                <button class="btn btn-secondary" disabled>
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    Processing...
                                                </button>
                                            }
                                            else if (plugin.Data.IsActive)
                                            {
                                                <button class="btn btn-sm btn-warning" @onclick="DisableVersion" title="Unlist this version from public listings">
                                                    <i class="bi bi-eye-slash me-2"></i>Unlist Version
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="EnableVersion" title="List this version in public listings">
                                                    <i class="bi bi-eye me-2"></i>List Version
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>

                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="alert @(statusSuccess ? "alert-success" : "alert-danger") alert-dismissible border-0 shadow-sm fade show mb-4" role="alert">
                        <i class="bi @(statusSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i>
                        @statusMessage
                        <button type="button" class="btn-close" @onclick="ClearStatusMessage"></button>
                    </div>
                }

                @if (!plugin.Data.IsActive)
                {
                    <div class="alert alert-warning border-0 shadow-sm mb-4" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
                            <div>
                                <h6 class="alert-heading mb-2">This version is unlisted</h6>
                                <p class="mb-0">It won't appear in public plugin listings or search results, but can still be accessed directly via this URL.</p>
                            </div>
                        </div>
                    </div>
                }

                <!-- Installation Tabs with Active Tab Copy Button -->
                <div class="card border shadow-sm mb-4">
                    <div class="card-body p-4">
                        <!-- Header with inline Copy button -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-code-square me-2 text-primary"></i>
                                Installation
                            </h5>
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link @(ActiveTab == "flowsynx-manager" ? "active" : "")"
                                        @onclick='() => ActiveTab = "flowsynx-manager"'>
                                    FlowSynx Manager
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(ActiveTab == "flowctl-cli" ? "active" : "")"
                                        @onclick='() => ActiveTab = "flowctl-cli"'>
                                    FlowCtl CLI
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content p-0 border border-top-0 rounded-bottom">
                            @if (ActiveTab == "flowsynx-manager")
                            {
                                <div class="tab-pane fade show active">
                                    <CodeBlock Code="@flowSynxCode" />
                                </div>
                            }
                            else if (ActiveTab == "flowctl-cli")
                            {
                                <div class="tab-pane fade show active">
                                    <CodeBlock Code="@flowctlCode" />
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Tabs Section -->
                <div class="card border shadow-sm">
                    <div class="card-header bg-white border pt-4 px-4 bg-light">
                        <ul class="nav nav-tabs card-header-tabs" id="pluginDetailsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-semibold" id="readme-tab" data-bs-toggle="tab" 
                                        data-bs-target="#readme" type="button" role="tab" 
                                        aria-controls="readme" aria-selected="true">
                                    <i class="bi bi-file-text me-2"></i>README
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-semibold" id="versions-tab" data-bs-toggle="tab" 
                                        data-bs-target="#versions" type="button" role="tab" 
                                        aria-controls="versions" aria-selected="false">
                                    <i class="bi bi-clock-history me-2"></i>Versions
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-4">
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="readme" role="tabpanel" aria-labelledby="readme-tab">
                                <MarkdownViewer PluginType="@plugin.Data.Type" PluginVersion="@plugin.Data.Version" />
                            </div>
                            <div class="tab-pane fade" id="versions" role="tabpanel" aria-labelledby="versions-tab">
                                <PluginVersionList PluginType="@plugin.Data.Type" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card border shadow-sm sticky-sidebar">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">
                            <i class="bi bi-info-circle me-2 text-primary"></i>About
                        </h5>

                        @if (plugin.Data.IsTrusted)
                        {
                            <div class="alert alert-primary border mb-4 p-3">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-patch-check-fill me-2 fs-4"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">Trusted Plugin</h6>
                                        <small class="text-muted">This plugin has been verified and is trusted by the FlowSynx team.</small>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="info-section">
                            <div class="info-item mb-3">
                                <div class="d-flex align-items-center text-muted small mb-1">
                                    <i class="bi bi-download me-2"></i>
                                    <span>Downloads</span>
                                </div>
                                <div class="fw-bold fs-5">@plugin.Data.TotalDownload.ToString("N0")</div>
                            </div>

                            <div class="info-item mb-3">
                                <div class="d-flex align-items-center text-muted small mb-1">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <span>Last Updated</span>
                                </div>
                                <div class="fw-semibold">@TimeHelper.GetHumanReadableDate(plugin.Data.LastUpdated)</div>
                            </div>

                            @if (!string.IsNullOrEmpty(plugin.Data.CategoryTitle))
                            {
                                <div class="info-item mb-3">
                                    <div class="d-flex align-items-center text-muted small mb-1">
                                        <i class="bi bi-bookmark-check me-2"></i>
                                        <span>Category</span>
                                    </div>
                                    <span class="fw-semibold">@plugin.Data.CategoryTitle</span>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(plugin.Data.License))
                            {
                                <div class="info-item mb-3">
                                    <div class="d-flex align-items-center text-muted small mb-1">
                                        <i class="bi bi-shield-check me-2"></i>
                                        <span>License</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(plugin.Data.LicenseUrl))
                                    {
                                        <a href="@plugin.Data.LicenseUrl" target="_blank" class="text-decoration-none fw-semibold">
                                            @plugin.Data.License
                                            <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="fw-semibold">@plugin.Data.License</div>
                                    }
                                </div>
                            }
                        </div>

                        <div class="links-section">
                            <h6 class="fw-bold mb-3">Links</h6>

                            @if (!string.IsNullOrEmpty(plugin.Data.ProjectUrl))
                            {
                                <div class="d-flex">
                                    <i class="bi bi-globe me-2"></i>
                                    <a href="@plugin.Data.ProjectUrl" target="_blank" class="d-block text-decoration-none mb-2">
                                        Project Website
                                    </a>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(plugin.Data.RepositoryUrl))
                            {
                                <div class="d-flex">
                                    <i class="bi bi-git me-2"></i>
                                    <a href="@plugin.Data.RepositoryUrl" target="_blank" class="d-block text-decoration-none mb-2">
                                        Source Repository
                                    </a>
                                </div>
                            }

                            <div class="d-flex">
                                <i class="bi bi-download me-2"></i>
                                <a href="/api/plugins/@plugin.Data.Type/@plugin.Data.Version/download" 
                                   class="d-block text-decoration-none mb-2">
                                    Download Plugin
                                </a>
                            </div>
                        </div>

                        @if (plugin.Data.Owners.Any())
                        {
                            <div class="owners-section my-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-people me-2"></i>Owners
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <span>
                                        @foreach (var owner in plugin.Data.Owners)
                                        {
                                            <a href="/profiles/@owner">@owner</a>
                                            @if (owner != plugin.Data.Owners.Last())
                                            {
                                                <span>, </span>
                                            }
                                        }
                                    </span>
                                </div>
                            </div>
                        }

                        @if (plugin.Data.Tags.Any())
                        {
                            <div class="tags-section my-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-tags me-2"></i>Tags
                                </h6>
                                <div class="plugin-tags">
                                    @foreach (var tag in plugin.Data.Tags)
                                    {
                                        <a href="/plugins?q=tag:@tag" class="plugin-tag">
                                            #@tag
                                        </a>
                                    }
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(plugin.Data.Copyright))
                        {
                            <hr class="my-4">
                            <div class="copyright-section">
                                <small class="text-muted d-block">
                                    @plugin.Data.Copyright
                                </small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Inject] private IJSRuntime JS { get; set; }

    [Parameter]
    public string Type { get; set; } = "";

    [Parameter]
    public string Version { get; set; } = "";

    private string flowSynxCode => $"{Type}:{Version}";
    private string flowctlCode => $"flowctl plugins install \"{Type}:{Version}\"";

    Result<PluginDetailsResponse>? plugin;
    private bool isOwner = false;
    private bool isProcessing = false;
    private string? statusMessage;
    private bool statusSuccess = false;
    private string? currentUsername;

    private string ActiveTab { get; set; } = "flowsynx-manager";

    protected override async Task OnInitializedAsync()
    {
        plugin = await Stats.GetPluginDetails(Type, Version);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUsername = user.FindFirst("login")?.Value ?? user.FindFirst("preferred_username")?.Value;

            if (!string.IsNullOrEmpty(currentUsername) && plugin?.Data?.Owners != null)
            {
                isOwner = plugin.Data.Owners.Any(o =>
                    o.Equals(currentUsername, StringComparison.OrdinalIgnoreCase));
            }
        }
    }

    private async Task CopyActiveTabCode()
    {
        string codeToCopy = ActiveTab switch
        {
            "flowsynx-manager" => flowSynxCode,
            "flowctl-cli" => flowctlCode,
            _ => ""
        };

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", codeToCopy);
    }

    private async Task EnableVersion()
    {
        isProcessing = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var result = await Stats.EnablePluginVersion(Type, Version);

            if (result.Succeeded)
            {
                statusSuccess = true;
                statusMessage = "Plugin version listed successfully!";

                // Refresh plugin data
                plugin = await Stats.GetPluginDetails(Type, Version);
            }
            else
            {
                statusSuccess = false;
                statusMessage = string.Join(", ", result.Messages);
            }
        }
        catch (Exception ex)
        {
            statusSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DisableVersion()
    {
        isProcessing = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var result = await Stats.DisablePluginVersion(Type, Version);

            if (result.Succeeded)
            {
                statusSuccess = true;
                statusMessage = "Plugin version unlisted successfully!";

                // Refresh plugin data
                plugin = await Stats.GetPluginDetails(Type, Version);
            }
            else
            {
                statusSuccess = false;
                statusMessage = string.Join(", ", result.Messages);
            }
        }
        catch (Exception ex)
        {
            statusSuccess = false;
            statusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void ClearStatusMessage()
    {
        statusMessage = null;
        StateHasChanged();
    }
}