@page "/profiles/{UserName}"

@using FlowSynx.PluginRegistry.Application.Features.Plugins.Query.PluginsListByProfile
@using FlowSynx.PluginRegistry.Application.Features.Plugins.Query.PluginsStatisticsByProfile
@using FlowSynx.PluginRegistry.Application.Wrapper
@using FlowSynx.Pluginregistry.Components.Shared
@using FlowSynx.Pluginregistry.Services
@using Microsoft.AspNetCore.WebUtilities

@implements IDisposable

@inject NavigationManager Navigation
@inject IStatsApiService Stats

<PageTitle>Profile (@UserName) | FlowSynx Plugin Registry</PageTitle>

<div class="container py-5">
    @if (plugins == null)
    {
        <div class="col-12">
            <LoadingSpinner Message="Loading profile..." />
        </div>
    }
    else if (!plugins.Succeeded)
    {
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <ErrorAlert Title="Error Loading Profile" 
                           Message="@string.Join(Environment.NewLine, plugins.Messages)" />
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- Profile Sidebar -->
            <div class="col-lg-3 order-lg-2">
                <ProfileSidebar Email="@email" 
                               UserName="@UserName" 
                               TotalPlugins="@totalPlugins" 
                               TotalDownloads="@totalPluginsDownloads" />
            </div>

            <!-- Plugins List -->
            <div class="col-lg-9 order-lg-1">
                <ProfilePluginsList Plugins="@plugins"
                                   UserName="@UserName"
                                   TotalPlugins="@totalPlugins"
                                   CurrentPage="@currentPage"
                                   TotalPages="@totalPages" />
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string UserName { get; set; } = "";

    PaginatedResult<PluginsListByProfileResponse>? plugins;
    Result<PluginsStatisticsByProfileResponse>? pluginStatistics;

    private int currentPage = 1;
    private int totalPages => plugins == null ? 1 : plugins.TotalPages;

    private string? email => (pluginStatistics == null || !pluginStatistics.Succeeded) 
        ? "" 
        : pluginStatistics.Data.Email;

    private int totalPlugins => (pluginStatistics == null || !pluginStatistics.Succeeded) 
        ? 0 
        : pluginStatistics.Data.TotalCount;

    private long totalPluginsDownloads => (pluginStatistics == null || !pluginStatistics.Succeeded) 
        ? 0 
        : pluginStatistics.Data.TotalDownload;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await LoadPage();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        await LoadPage();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadPage()
    {
        var uri = new Uri(Navigation.Uri);
        if (!string.IsNullOrWhiteSpace(uri.Query))
        {
            var queryStrings = QueryHelpers.ParseQuery(uri.Query);

            if (queryStrings.TryGetValue("page", out var pageStr) && int.TryParse(pageStr, out var page))
                currentPage = Math.Max(page, 1);
            else
                currentPage = 1;
        }

        plugins = await Stats.GetPluginsByUserName(UserName, currentPage);
        pluginStatistics = await Stats.GetPluginStatisticsByUsername(UserName);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}