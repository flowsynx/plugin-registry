@page "/manage/upload"
@using FlowSynx.PluginRegistry.Domain.Profile
@using FlowSynx.Pluginregistry.Services
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpContextAccessor HttpContextAccessor
@inject IProfileService profileService
@inject IStatsApiService Stats
@attribute [Authorize]

<PageTitle>Upload Plugin | FlowSynx Plugin Registry</PageTitle>

<div class="container p-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-sm border">
                <div class="card-body p-4 p-md-5">
                    <div class="text-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-cloud-upload text-primary mb-3" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
                            <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
                        </svg>
                        <h2 class="fw-bold mb-3">Upload Your Plugin</h2>
                        <p class="text-muted mb-0">
                            Share your plugin with the FlowSynx community by uploading a <code>.fspack</code> package file.
                        </p>
                    </div>

                    <div class="alert border-primary mb-4 bg-primary-subtle" role="alert">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                                </svg>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <strong>Package Requirements</strong>
                                <ul class="mb-0 mt-2 small">
                                    <li>Valid <b class="text-primary">.fspack</b> archive format</li>
                                    <li>Include a <b class="text-primary">metadata.json</b> file with plugin metadata</li>
                                    <li>All necessary plugin files and dependencies</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="fileUpload" class="form-label fw-semibold">Select Plugin Package</label>
                        <InputFile id="fileUpload" OnChange="HandleFileSelected" accept=".fspack" 
                                   class="form-control form-control border border-secondary rounded-3" 
                                   disabled="@IsUploading" />
                        <div class="form-text mt-2">
                            <small>Maximum file size: <b>100MB</b> | Accepted format: <b>.fspack</b></small>
                        </div>
                    </div>

                    @if (UploadMessage is not null)
                    {
                        <div class="alert alert-@UploadMessage.Type alert-dismissible fade show border-0 shadow-sm" role="alert">
                            <div class="d-flex align-items-center">
                                @if (UploadMessage.Type == "success")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                                    </svg>
                                }
                                <div class="flex-grow-1">@UploadMessage.Text</div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (IsUploading)
                    {
                        <div class="card border-primary bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-circle-fill me-2" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0m-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z"/>
                                        </svg>
                                        Uploading your plugin...
                                    </span>
                                    <span class="badge bg-primary fs-6">@ProgressPercentage%</span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" 
                                         style="width:@ProgressPercentage%"
                                         aria-valuenow="@ProgressPercentage" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <span class="fw-semibold">@ProgressPercentage%</span>
                                    </div>
                                </div>
                                <small class="text-muted mt-2 d-block">Please wait while we process your plugin package...</small>
                            </div>
                        </div>
                    }
                </div>
            </div>

@*             <div class="mt-4 text-center text-muted">
                <small>
                    Need help? Check out our
                    <a href="https://flowsynx.io/docs/plugin-development" class="text-decoration-none">plugin development guide</a> or
                    <a href="https://flowsynx.io/support" class="text-decoration-none">contact support</a>.
                </small>
            </div> *@
        </div>
    </div>
</div>

@code {
    private UploadMessageModel? UploadMessage;
    private bool IsUploading = false;
    private int ProgressPercentage = 0;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file == null)
        {
            UploadMessage = new UploadMessageModel
            {
                Text = "No file selected. Please choose a valid .fspack file.",
                Type = "danger"
            };
            return;
        }

        IsUploading = true;
        ProgressPercentage = 0;
        UploadMessage = null;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var User = authState.User;
            string? userName = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var profileId = await profileService.GetByUserId(userName, CancellationToken.None);

            await Stats.UploadFileAsync(file, async (percent) =>
            {
                ProgressPercentage = percent;
                await InvokeAsync(StateHasChanged);
            }, profileId.Id);

            UploadMessage = new UploadMessageModel
            {
                Text = "🎉 Upload successful! Your plugin has been published to the registry.",
                Type = "success"
            };
        }
        catch (Exception ex)
        {
            UploadMessage = new UploadMessageModel
            {
                Text = $"Upload failed: {ex.Message}",
                Type = "danger"
            };
        }
        finally
        {
            IsUploading = false;
        }
    }

    private class UploadMessageModel
    {
        public string Text { get; set; } = string.Empty;
        public string Type { get; set; } = "success"; // or "danger", "info", etc.
    }
}